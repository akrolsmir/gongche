<!DOCTYPE html>
<meta charset="utf-8">
<title>Query</title>
<link rel="stylesheet" href="prosody.css">
<link rel="stylesheet" href="https://unpkg.com/vue-nav-tabs/themes/vue-tabs.css">
<div class="songdata">
  <h1>Query Engine</h1>
  <div style="background:lightgrey">
    <p> Select songs: <input type="text" id="songsQuery" v-model="songsQuery"> 
    <p> (Examples: <code>id:287.1,287.2</code> | <code>title:春</code> | <code>region:s</code> | <code>mode:仙呂</code>)
    <h3>{{ matchedSongs.length }} pieces</h3>
    <div id="results" style="overflow:auto; max-height:200px; background:lightgrey">
      <ul>
        <li v-for='song in matchedSongs'>
          {{ song.id }} 《{{ song.title }} - {{ song.composer }}》 （{{ song.modeKey }}）
          <a v-bind:href='`sheet.html?songId=${song.id}`'>Sheet</a> | 
          <a v-bind:href='`prosody.html?songTitle=${song.title}`'>Prosody</a>
        </li>
      </ul>
    </div>
  </div>
  <vue-tabs><v-tab title="Motifs"><div>
  <div style="background:lightblue">
    <button v-on:click="findAllMotifs">Find motifs</button>
    <div id="results" style="overflow:auto; max-height:200px;">
      <ul>
        <li v-for='motif in motifs'>
          {{ motif[1] }} instances of
          <a href='#results' v-on:click="setLinesQuery(`melody:${motif[0]}`)">{{ motif[0] }}</a>
        </li>
      </ul>
    </div>
  </div>
  <p> Filter lines: <input type="text" id="linesQuery" v-model="linesQuery">
  <p> (Examples: <code>melody:216.5.6.</code> | <code>fuzzy:65323</code> | <code>tone:平平去</code> | <code>tone:平平仄</code> | <code>tone:平陰平陽仄陰</code>)
  <p>
    <div v-if="matchedLines.length > 50">
      Showing first 50 of {{matchedLines.length}} matches:
    </div>
    <div v-else>
      Showing {{matchedLines.length}} matches:
    </div>
  <template v-for="line in matchedLines.slice(0, 50)">
    <table>
      <tbody>
        <tr>
          <td style='text-align: center' v-bind:colspan='line.words.length + 1'>
            Line {{ line.index }} of {{ line.song.id }} 《{{ line.song.title }} - {{ line.song.composer }}》
          </td>
        </tr>
        <template v-for='header in headers'>
          <tr>
            <th>{{ header.display }}</th>
            <template v-for="word in line.words">
              <td>{{ word[header.id] }}</td>
            </template>
          </tr>
        </template>
      </tbody>
    </table>
  </template>
  </div></v-tab>
    <v-tab title="Tone">
      <p> Find tone: <input type="text" id="toneQuery" v-model="toneQuery">
      <p> (Examples: <code>平</code> | <code>上</code> | <code>去</code> | <code>入</code>)
      <p>
        <div v-if="toneQuery">
          Found all contours for "{{ toneQuery }}":<br>
          (Positive contours indicate the song ended on a higher note.)
        </div>
        <div v-else>
          All contours for words with 2 or more notes:<br>
          (Positive contours indicate the song ended on a higher note.)
        </div>
      <canvas ref="contourChart" id="contourChart" width="400" height="400"></canvas>
      <ul>
        <li v-for='(values, contour) in matchedToneContours'>
          Contour {{ contour }}: {{ values.count }}
          <ul>
            <li v-for='title in Array.from(values.titles).splice(0, 10)'>
              {{ title }}
            </li>
            <li v-if='values.titles.size > 10'>
              <a href="#" v-on:click="showAlert(Array.from(values.titles).join(', '))">...</a>
            </li>
          </ul>
        </li>
      </ul>
    </v-tab>
    <v-tab title="Rhythm"><div>
      <p> Find symbol: <input type="text" id="rhythmQuery" v-model="rhythmQuery">
      <p> (Examples: <code>。</code> | <code>、</code> | <code>_</code> | <code>▯</code> | <code>L</code> | <code>﹆</code> | <code>╚</code>)
      <p><div v-if="rhythmQuery">
        Found "{{ rhythmQuery }}" at the following line positions:
      </div>
      <div v-else>
        Total word counts across all lines:
      </div>
      <canvas ref="rhythmChart" id="rhythmChart" width="400" height="400"></canvas>
    </div></v-tab>
    <v-tab title="Line Lengths">
      <p> Distribution of line lengths:
      <canvas ref="lengthChart" id="lengthChart" width="400" height="400"></canvas>
    </v-tab>
  </vue-tabs>
</div>
<script src="https://unpkg.com/vue-nav-tabs/dist/vue-tabs.js"></script>
<script src="https://www.gstatic.com/firebasejs/5.5.5/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/5.5.5/firebase-firestore.js"></script>
<script src="https://cdn.jsdelivr.net/npm/vue/dist/vue.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/2.8.0/Chart.bundle.js"></script>
<script src="models/song.js"></script>
<Script src="database.js"></Script>
<script src="assets/mulu.js"></script>
<script type="module" src="query.js"></script>
